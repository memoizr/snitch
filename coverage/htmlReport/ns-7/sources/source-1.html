


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > UsersControllerKt</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">snitch.example.api.users</a>
</div>

<h1>Coverage Summary for Class: UsersControllerKt (snitch.example.api.users)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">UsersControllerKt</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
</tr>
  <tr>
    <td class="name">UsersControllerKt$createPost$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$createPost$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$createPost$2$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$createUser$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$createUser$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$createUser$2$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$createUser$2$2$WhenMappings</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$deletePost$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$getPost$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$getPosts$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$updatePost$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$userLogin$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/21)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/52)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$3$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$4$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$5$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$1$1$invoke$$inlined$isHandledBy$6$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$invoke$$inlined$isHandledBy$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$invoke$$inlined$isHandledBy$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$invoke$$inlined$isHandledBy$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$usersController$1$1$invoke$$inlined$isHandledBy$2$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$withExposedTransaction$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$withExposedTransaction$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$withTransaction$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">UsersControllerKt$withTransaction$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/51)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/194)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package snitch.example.api.users
&nbsp;
&nbsp;import snitch.parameters.PathParam
&nbsp;import snitch.request.RequestWrapper
&nbsp;import snitch.request.TypedRequestWrapper
&nbsp;import snitch.request.handling
&nbsp;import snitch.request.parsing
&nbsp;import snitch.router.Router
&nbsp;import snitch.router.decorateWith
&nbsp;import snitch.router.decoration
&nbsp;import snitch.router.routes
&nbsp;import snitch.types.ErrorResponse
&nbsp;import snitch.types.StatusCodes
&nbsp;import org.jetbrains.exposed.sql.transactions.transaction
&nbsp;import snitch.example.api.*
&nbsp;import snitch.example.api.Paths.postId
&nbsp;import snitch.example.api.Paths.userId
&nbsp;import snitch.example.api.auth.authenticated
&nbsp;import snitch.example.api.auth.hasAdminRole
&nbsp;import snitch.example.api.auth.principal
&nbsp;import snitch.example.api.auth.principalEquals
&nbsp;import snitch.example.database.PostgresErrorCodes
&nbsp;import snitch.example.database.RepositoriesModule.postsRepository
&nbsp;import snitch.example.database.RepositoriesModule.usersRepository
&nbsp;import snitch.example.security.JWTClaims
&nbsp;import snitch.example.security.Role
&nbsp;import snitch.example.security.SecurityModule.hasher
&nbsp;import snitch.example.security.SecurityModule.jwt
&nbsp;import snitch.example.types.*
&nbsp;
<b class="nc">&nbsp;val usersController = routes {</b>
<b class="nc">&nbsp;    withTransaction {</b>
<b class="nc">&nbsp;        POST() with body&lt;CreateUserRequest&gt;() isHandledBy createUser</b>
<b class="nc">&nbsp;        POST(&quot;login&quot;) with body&lt;LoginRequest&gt;() isHandledBy userLogin</b>
<b class="nc">&nbsp;</b>
<b class="nc">&nbsp;        userId / &quot;posts&quot; / {</b>
<b class="nc">&nbsp;            authenticated {</b>
<b class="nc">&nbsp;                GET() onlyIf principalEquals(userId) isHandledBy getPosts</b>
<b class="nc">&nbsp;                GET() onlyIf principalEquals(userId) isHandledBy getPosts</b>
<b class="nc">&nbsp;                POST() onlyIf principalEquals(userId) with body&lt;CreatePostRequest&gt;() isHandledBy createPost</b>
&nbsp;
<b class="nc">&nbsp;                GET(postId) isHandledBy getPost</b>
<b class="nc">&nbsp;                PUT(postId) with body&lt;UpdatePostRequest&gt;() onlyIf principalEquals(userId) isHandledBy updatePost</b>
<b class="nc">&nbsp;                DELETE(postId) onlyIf (principalEquals(userId) or hasAdminRole) isHandledBy deletePost</b>
&nbsp;            }
&nbsp;        }
&nbsp;    }
&nbsp;}
&nbsp;
<b class="nc">&nbsp;val Router.withTransaction get() = decorateWith { transaction { next() } }</b>
&nbsp;
<b class="nc">&nbsp;private val withExposedTransaction = decoration { transaction { next() } }</b>
&nbsp;
<b class="nc">&nbsp;private val updatePost by parsing&lt;UpdatePostRequest&gt;() handling {</b>
<b class="nc">&nbsp;    postsRepository().updatePost(</b>
<b class="nc">&nbsp;        UpdatePostAction(</b>
<b class="nc">&nbsp;            PostId(request[postId]),</b>
<b class="nc">&nbsp;            PostTitle(body.title),</b>
<b class="nc">&nbsp;            PostContent(body.content),</b>
&nbsp;        )
<b class="nc">&nbsp;    ).noContent</b>
&nbsp;}
&nbsp;
<b class="nc">&nbsp;private val getPost by handling {</b>
<b class="nc">&nbsp;    postsRepository().getPost(PostId(request[postId]))</b>
<b class="nc">&nbsp;        ?.toResponse?.ok</b>
<b class="nc">&nbsp;        ?: NOT_FOUND()</b>
&nbsp;}
&nbsp;
<b class="nc">&nbsp;private val deletePost by handling {</b>
<b class="nc">&nbsp;    postsRepository().deletePost(request.principal, PostId(request[postId]))</b>
<b class="nc">&nbsp;        .noContent</b>
&nbsp;}
&nbsp;
<b class="nc">&nbsp;private val getPosts by handling {</b>
<b class="nc">&nbsp;    postsRepository().getPosts(request.principal)</b>
<b class="nc">&nbsp;        .toResponse.ok</b>
&nbsp;}
&nbsp;
<b class="nc">&nbsp;private val createPost by parsing&lt;CreatePostRequest&gt;() handling {</b>
<b class="nc">&nbsp;    postsRepository().putPost(</b>
<b class="nc">&nbsp;        CreatePostAction(</b>
<b class="nc">&nbsp;            request.principal,</b>
<b class="nc">&nbsp;            PostTitle(body.title),</b>
<b class="nc">&nbsp;            PostContent(body.content),</b>
&nbsp;        )
<b class="nc">&nbsp;    ).mapSuccess {</b>
<b class="nc">&nbsp;        SuccessfulCreation(value).created</b>
<b class="nc">&nbsp;    }.mapFailure {</b>
<b class="nc">&nbsp;        FailedCreation().badRequest()</b>
&nbsp;    }
&nbsp;}
&nbsp;
<b class="nc">&nbsp;private val userLogin by parsing&lt;LoginRequest&gt;() handling {</b>
<b class="nc">&nbsp;    usersRepository().findHashBy(Email(body.email))</b>
<b class="nc">&nbsp;        ?.let {</b>
<b class="nc">&nbsp;            if (hasher().match(body.password, it.second))</b>
<b class="nc">&nbsp;                jwt().newToken(JWTClaims(it.first, Role.USER)).ok</b>
<b class="nc">&nbsp;            else null</b>
<b class="nc">&nbsp;        } ?: InvalidCredentials().badRequest()</b>
&nbsp;}
&nbsp;
<b class="nc">&nbsp;private val createUser by parsing&lt;CreateUserRequest&gt;() handling {</b>
<b class="nc">&nbsp;    usersRepository().putUser(</b>
<b class="nc">&nbsp;        CreateUserAction(</b>
<b class="nc">&nbsp;            UserName(body.name),</b>
<b class="nc">&nbsp;            Email(body.email),</b>
<b class="nc">&nbsp;            Password(body.password).hash</b>
&nbsp;        )
<b class="nc">&nbsp;    ).mapSuccess {</b>
<b class="nc">&nbsp;        SuccessfulCreation(value).created</b>
<b class="nc">&nbsp;    }.mapFailure {</b>
<b class="nc">&nbsp;        when (code) {</b>
<b class="nc">&nbsp;            PostgresErrorCodes.UNIQUE_VIOLATION -&gt; EmailExists().badRequest()</b>
<b class="nc">&nbsp;            else -&gt; SERVER_ERROR()</b>
&nbsp;        }
&nbsp;    }
&nbsp;}
&nbsp;
&nbsp;fun &lt;T, S : StatusCodes&gt; TypedRequestWrapper&lt;*&gt;.FORBIDDEN() =
<b class="nc">&nbsp;    ErrorResponse(403, &quot;forbidden&quot;).forbidden&lt;T, _, S&gt;()</b>
&nbsp;
&nbsp;fun &lt;T, S : StatusCodes&gt; RequestWrapper.FORBIDDEN() =
<b class="nc">&nbsp;    ErrorResponse(403, &quot;forbidden&quot;).forbidden&lt;T, _, S&gt;()</b>
&nbsp;
&nbsp;fun &lt;T, S : StatusCodes&gt; RequestWrapper.UNAUTHORIZED() =
<b class="nc">&nbsp;    ErrorResponse(401, &quot;unauthorized&quot;).unauthorized&lt;T, _, S&gt;()</b>
&nbsp;
&nbsp;fun &lt;T, S : StatusCodes&gt; TypedRequestWrapper&lt;*&gt;.NOT_FOUND() =
<b class="nc">&nbsp;    ErrorResponse(404, &quot;forbidden&quot;).notFound&lt;T, _, S&gt;()</b>
&nbsp;
&nbsp;fun &lt;T, S : StatusCodes&gt; TypedRequestWrapper&lt;*&gt;.SERVER_ERROR() =
<b class="nc">&nbsp;    ServerError().serverError&lt;T, _, S&gt;()</b>
&nbsp;
&nbsp;fun TypedRequestWrapper&lt;*&gt;.principalIsNot(param: PathParam&lt;out Any, *&gt;) =
<b class="nc">&nbsp;    request[param] != request.principal.value</b>
&nbsp;
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-06-30 16:58</div>
</div>
</body>
</html>
